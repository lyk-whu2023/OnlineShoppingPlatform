# 实验报告

**姓名**：[你的姓名]  
**学号**：[你的学号]  
**年级**：2023级  
**专业**：软件工程  
**指导教师**：[教师姓名]  
**实验日期**：2025年12月17日  

---

**实验类型**：
- [x] 独立实验课
- [ ] 含实验的理论课
- [ ] 计划外自选开放实验
- [ ] 学生自主式开放实验
- [ ] 大学生科技竞赛

**实验名称**：B/S架构企业级应用开发——在线购物平台 (OnlineShoppingPlatform)

## 一、预习部分

### 1. 实验原理
本实验基于 **B/S (Browser/Server)** 架构，采用前后端分离的开发模式。
- **后端**：基于 **Spring Boot 3.x** 框架，遵循 **MVC (Model-View-Controller)** 设计模式。利用 **MyBatis** 作为 ORM 框架实现 Java 对象与关系型数据库 MySQL 的映射。通过 RESTful API 与前端进行数据交互。核心业务逻辑（如订单处理）采用声明式事务管理。
- **前端**：基于 **Vue 3** 框架，采用 **MVVM (Model-View-ViewModel)** 模式。使用 **Vite** 进行构建，**Element Plus** 提供 UI 组件，**Axios** 处理 HTTP 请求，**Vue Router** 管理单页应用路由，**ECharts** 实现数据可视化。

### 2. 主要仪器设备
- **硬件**：个人计算机 (Windows 11, 16GB RAM)
- **开发工具**：
    - 后端：IntelliJ IDEA / Maven 3.8+
    - 前端：VS Code / Node.js v18+
    - 数据库：MySQL 8.0 / Navicat (或 DBeaver)
- **运行环境**：JDK 17, Node.js v18+

### 3. 实验目的
1.  深入理解开源软件生态，掌握 JavaEE 主流技术栈 (Spring Boot, MyBatis) 的应用。
2.  熟练使用 Vue 3 全家桶 (Vue, Router, Element Plus, Axios) 构建现代化的单页 Web 应用。
3.  掌握前后端分离架构下的接口设计、认证鉴权 (JWT) 及数据交互。
4.  深入理解事务管理 (`@Transactional`)、拦截器 (`HandlerInterceptor`) 等企业级开发核心概念。
5.  通过实战开发一个完整的在线购物平台，提升分析问题与解决实际问题的能力。

### 4. 实验内容
设计并实现一个功能完善的在线购物平台，包含以下核心模块：
-   **用户模块**：注册、登录 (JWT 签发)、个人信息管理、收货地址管理。
-   **商品模块**：商品浏览、搜索、分类筛选、商品详情展示（含图片种子生成逻辑）。
-   **交易模块**：购物车管理（增删改）、订单提交（原子性事务）、订单状态流转（待支付、待发货、已完成）。
-   **管理模块**：后台仪表盘统计（基于 ECharts）、商品/分类/用户/订单的增删改查管理。

### 5. 实验要求
-   功能完整，业务逻辑闭环。
-   代码规范，注释清晰，结构合理。
-   界面美观，交互流畅，具备良好的用户体验。
-   提交完整的源代码、数据库脚本及实验报告。

---

## 二、实验操作部分

### 1. 实验数据与数据库设计
系统使用 MySQL 数据库，设计遵循第三范式，核心表结构定义如下（参考 `schema.sql`）：

1.  **用户表 (`users`)**:
    -   `id`: BIGINT, 主键, 自增
    -   `username`: VARCHAR(64), 唯一索引
    -   `password_hash`: VARCHAR(255), 存储加密后的密码
    -   `role`: ENUM('admin','user'), 角色控制
    -   `status`: ENUM('enabled','disabled'), 账户状态

2.  **商品表 (`products`)**:
    -   `id`: BIGINT, 主键
    -   `category_id`: BIGINT, 外键关联 `categories`
    -   `price`: DECIMAL(10,2), 精度控制
    -   `stock`: INT, 库存
    -   `sales`: INT, 销量统计

3.  **订单表 (`orders`)**:
    -   `id`: BIGINT, 主键
    -   `user_id`: BIGINT, 外键关联 `users`
    -   `amount`: DECIMAL(10,2), 订单总额
    -   `status`: VARCHAR(32), 状态 ('pending', 'paid', 'shipped', 'completed', 'cancelled')
    -   `consignee_name/phone/detail`: 快照存储下单时的地址信息，防止后续地址修改影响历史订单。

4.  **订单明细表 (`order_items`)**:
    -   关联 `orders` 和 `products`，记录下单时的商品价格 (`price`) 和数量 (`qty`)，确保价格变动不影响历史订单金额。

5.  **其他表**: `carts`, `cart_items`, `addresses`, `shipments`, `payments` 等。

### 2. 实验操作过程

#### 2.1 后端实现 (Spring Boot)
1.  **项目初始化**：使用 Spring Initializr 创建项目，引入 Web, MyBatis, MySQL Driver, Lombok 等依赖。
2.  **配置数据源**：在 `application.properties` 中配置 MySQL 连接信息及 MyBatis 驼峰命名规则。
3.  **业务逻辑实现 (Service Layer)**：
    -   **订单创建 (`OrderServiceImpl.java`)**:
        -   使用 `@Transactional` 注解确保方法的原子性。
        -   逻辑：校验地址 -> 获取购物车商品 -> 遍历计算总价 -> **扣减库存** (`p.setStock(p.getStock() - it.getQty())`) -> **增加销量** -> 插入订单主表 -> 插入订单明细表 -> 返回订单 DTO。
        -   若库存不足或任何步骤失败，事务自动回滚，保证数据一致性。
    -   **安全认证 (`JwtAuthInterceptor.java`)**:
        -   实现 `HandlerInterceptor` 接口。
        -   在 `preHandle` 方法中拦截请求，提取 `Authorization` 头中的 Bearer Token。
        -   使用 `JwtUtil` 验证 Token 签名，解析 `uid` 和 `role`。
        -   将解析出的用户信息存入 `request.setAttribute`，供后续 Controller 使用。
        -   若验证失败，直接返回 401 Unauthorized。

4.  **接口开发 (Controller Layer)**：
    -   `StatsController`: 聚合 `ProductMapper`, `OrderMapper`, `UserMapper` 的数据，计算总销量、订单数，并筛选出销量 Top 5 的商品，为前端仪表盘提供数据支持。

#### 2.2 前端实现 (Vue 3)
1.  **项目搭建**：使用 `npm create vite@latest` 初始化 Vue 3 项目，安装 `element-plus`, `axios`, `vue-router`, `echarts`。
2.  **网络层封装 (`http.js`)**:
    -   配置 Axios 全局拦截器。
    -   **请求拦截**：自动从 `localStorage` 获取 Token 并添加到请求头。
    -   **响应拦截**：统一处理 401 状态码（跳转登录页）和 403 状态码（提示无权限）。
3.  **数据可视化 (`AdminStats.vue`)**:
    -   使用 `echarts.init` 初始化图表实例。
    -   在 `onMounted` 生命周期钩子中调用 `getStats` API 获取数据。
    -   动态配置 ECharts 的 `xAxis` (商品名称) 和 `series` (销量数据)，实现柱状图渲染。
4.  **状态管理**:
    -   利用 Vue 3 的 `ref` 和 `reactive` 实现组件内的响应式状态管理。
    -   使用 `localStorage` 持久化用户登录状态，防止刷新丢失。

#### 2.3 关键功能测试
1.  **并发测试**：模拟多个请求同时下单，验证数据库库存扣减的正确性（通过 SQL 日志观察）。
2.  **权限测试**：尝试使用普通用户 Token 访问 `/api/admin/*` 接口，验证后端拦截器是否正确拦截并返回 403。
3.  **流程测试**：完整走通 注册 -> 登录 -> 浏览 -> 加购 -> 下单 -> 支付(模拟) -> 发货 -> 收货 流程。

### 3. 结论
经过开发与测试，本系统已成功实现需求分析中的所有核心功能。
-   **架构合理**：前后端分离架构使得开发维护更加灵活。
-   **数据一致**：通过事务管理确保了订单与库存数据的一致性。
-   **安全可靠**：JWT 认证机制有效保护了用户隐私和系统资源。
-   **交互友好**：前端界面响应迅速，数据可视化直观展示了系统运营状况。

---

## 三、实验效果分析

### 1. 实验完成情况
-   **基础功能**：用户注册登录、商品展示、购物车、下单流程均已完成且运行稳定。
-   **高级功能**：
    -   实现了基于 JWT 的无状态认证机制。
    -   后台管理系统功能完备，集成了 ECharts 数据可视化。
    -   订单系统支持完整的状态流转逻辑。
    -   实现了基于角色的权限控制 (RBAC)，区分普通用户与管理员。

### 2. 遇到的问题与解决方案
1.  **问题**：前端 ECharts 图表在容器未渲染完成时初始化报错。
    -   **解决**：将 ECharts 初始化逻辑放在 `onMounted` 钩子中，并确保 DOM 元素 (`id="chart"`) 已存在。
2.  **问题**：订单金额计算精度丢失。
    -   **解决**：后端统一使用 `BigDecimal` 进行金额计算，数据库使用 `DECIMAL(10,2)` 类型存储。
3.  **问题**：跨域请求 (CORS) 问题。
    -   **解决**：在 Spring Boot 中配置 `WebConfig` 实现 `addCorsMappings`，允许前端域名的跨域访问。

### 3. 收获与总结
通过本次实验，我深刻体会到了企业级应用开发的复杂性与严谨性。
-   **技术层面**：深入掌握了 Spring Boot 的事务管理机制、MyBatis 的映射原理以及 Vue 3 的组件化开发模式。
-   **工程层面**：学会了如何进行数据库表结构设计、API 接口设计以及前后端联调。
-   **展望**：未来计划引入 Redis 缓存热点商品数据以应对高并发场景，并对接真实支付网关（如支付宝沙箱）以完善交易闭环。
