# 后端设计（Spring Boot + MyBatis）

- 技术栈：`Spring Boot 4`、`MyBatis`、`MySQL`、`Java 17`
- 分层结构：`Controller`（接口适配）→ `Service`（业务编排与 DTO/Entity 转换）→ `Mapper`（SQL 访问）→ `Entity`（数据模型）
- 配置：应用入口 `src/main/java/org/example/onlineshoppingplatform/OnlineShoppingPlatformApplication.java:1`；端口 `server.port=10002`；数据源 `spring.datasource.*`；MyBatis 驼峰映射 `src/main/resources/application.properties:2`

## 模块职责

- 商品：`ProductService` 与 `ProductController` 提供查询、详情、图片、增删改
- 分类：`CategoryService` 与 `CategoryController` 提供列表、增删改
- 地址：`AddressService` 与 `AddressController` 提供用户地址 CRUD
- 购物车：`CartService` 与 `CartController` 提供购物车增删改查
- 订单：`OrderService` 与 `OrderController` 提供下单、查询、状态变更
- 支付：`PaymentService` 与 `PaymentController` 提供订单支付记录的查询与更新
- 物流：`ShipmentService` 与 `ShipmentController` 提供订单物流信息的查询与更新
- 用户与认证：`UserService`、`UserController`、`AuthController` 提供注册、登录、用户信息与状态管理

## DTO ↔ Entity 映射

- 商品：`ProductDTO` 映射 `Product`，并补充 `categoryName` 与 `images`
- 订单：`OrderDTO` 映射 `Order`，并聚合 `OrderItemDTO[]`
- 地址、支付、物流、用户均有对应 DTO 与实体的直接映射

## 关键实现位置

- 商品查询与详情：`src/main/java/org/example/onlineshoppingplatform/controller/ProductController.java:15`
- 订单创建：`src/main/java/org/example/onlineshoppingplatform/service/impl/OrderServiceImpl.java:40`
- 购物车操作：`src/main/java/org/example/onlineshoppingplatform/service/impl/CartServiceImpl.java:31`
- 支付更新：`src/main/java/org/example/onlineshoppingplatform/service/impl/PaymentServiceImpl.java:24`
- 物流更新：`src/main/java/org/example/onlineshoppingplatform/service/impl/ShipmentServiceImpl.java:24`

## 业务流程

- 下单流程：
  - 读取用户购物车 → 计算总价 → 校验并扣减库存 → 生成订单与明细 → 清空购物车 → 返回 `OrderDTO`
- 商品图片：从 `product_images` 读取，返回 URL 或种子字段
- 用户认证：使用 JWT（`Authorization: Bearer <token>`），后端拦截器统一解析用户 ID

## 错误与返回约定

- 统一使用 HTTP 状态码；响应体为 DTO 或空（204）
- 控制器直接返回 DTO，不包裹统一响应体；前端请求失败时依据状态码处理

## 数据库与 MyBatis

- Mapper 层统一通过注解 SQL 实现（如 `ProductMapper`、`OrderMapper` 等）
- MySQL 依赖：`pom.xml:45` 使用 `mysql-connector-j`，运行时加载
- Mapper 扫描与会话工厂：`@MapperScan("org.example.onlineshoppingplatform.mapper")` 与 `src/main/java/org/example/onlineshoppingplatform/config/MybatisConfig.java:1`

## 安全与后续

- 已移除 `X-User-Id` 透传头，统一通过 JWT 拦截器在请求上下文中提供 `userId`
- 可补充 Bean 校验与全局异常处理器以提升健壮性
